#!/usr/bin/env node
/**
 * Generate Judge artifacts from ruleset_v1.json (Single Source of Truth).
 *
 * Outputs:
 * - apps/judge/src/generated/ruleset.ts
 * - apps/judge/README.rules.md
 * - apps/web/src/generated/judge_ruleset.schema.json
 *
 * This script is dependency-free on purpose (simple validation only).
 */
import fs from "node:fs";
import path from "node:path";

const repoRoot = process.cwd();

function readJson(fp) {
  return JSON.parse(fs.readFileSync(fp, "utf8"));
}

function die(msg) {
  console.error("[gen_ruleset] " + msg);
  process.exit(1);
}

function isObj(x){ return x && typeof x === "object" && !Array.isArray(x); }

function validate(r) {
  if (!isObj(r)) die("ruleset is not an object");
  for (const k of ["schema_version","name","required_metrics","evidence","sufficiency","time_coverage","qc","marker","determinism"]) {
    if (!(k in r)) die("missing required key: " + k);
  }
  if (!Array.isArray(r.required_metrics) || r.required_metrics.length === 0) die("required_metrics must be non-empty array");
  if (!isObj(r.evidence?.raw_sample) || !isObj(r.evidence?.marker)) die("evidence.raw_sample and evidence.marker required");
  if (!isObj(r.sufficiency) || !isObj(r.time_coverage) || !isObj(r.qc)) die("sufficiency/time_coverage/qc required");
  // basic C-2 / C-3 invariants
  if (!Array.isArray(r.time_coverage.exclusion_kinds)) die("time_coverage.exclusion_kinds must be array");
  if (!Array.isArray(r.evidence.raw_sample.missing_origin_quality_values)) die("evidence.raw_sample.missing_origin_quality_values must be array");
  if (!Array.isArray(r.evidence.raw_sample.missing_origin_exclude_from)) die("evidence.raw_sample.missing_origin_exclude_from must be array");
  return true;
}

function writeFile(fp, content) {
  fs.mkdirSync(path.dirname(fp), { recursive: true });
  fs.writeFileSync(fp, content, "utf8");
}

const rulesetPath = path.join(repoRoot, "config/judge/ruleset_v1.json");
const schemaPath  = path.join(repoRoot, "config/judge/ruleset_v1.schema.json");

if (!fs.existsSync(rulesetPath)) die("missing: " + rulesetPath);
if (!fs.existsSync(schemaPath))  die("missing: " + schemaPath);

const ruleset = readJson(rulesetPath);
validate(ruleset);

// 1) TS const
const tsOut = path.join(repoRoot, "apps/judge/src/generated/ruleset.ts");
const generatedAt = new Date().toISOString();

const ts = `/* eslint-disable */
// AUTO-GENERATED by apps/judge/scripts/gen_ruleset.mjs
// Source of truth: config/judge/ruleset_v1.json
// Generated at: ${generatedAt}

export type RulesetV1 = typeof RULESET_V1;

export const RULESET_V1 = ${JSON.stringify(ruleset, null, 2)} as const;

// Helpers shared by stages (centralize semantics here)
export function baseMetricOf(metric: string, requiredBases: readonly string[], sep: string): string | null {
  if (!metric) return null;
  for (const base of requiredBases) {
    if (metric === base) return base;
    if (metric.startsWith(base + sep)) return base;
  }
  return null;
}

export function isMissingOriginQuality(q: unknown): boolean {
  return RULESET_V1.evidence.raw_sample.missing_origin_quality_values.includes(String(q));
}

export function shouldExcludeMissingOriginFrom(kind: "sufficiency"|"coverage"|"qc"): boolean {
  return RULESET_V1.evidence.raw_sample.missing_origin_exclude_from.includes(kind);
}

export function isExclusionMarkerKind(kind: unknown): boolean {
  return RULESET_V1.marker.exclusion_kinds.includes(String(kind));
}
`;
writeFile(tsOut, ts);

// 2) README snippet
const mdOut = path.join(repoRoot, "apps/judge/README.rules.md");
const md = `# Judge ruleset (SSOT)

This repo uses **config/judge/ruleset_v1.json** as the **Single Source of Truth**.

Generated artifacts:
- \`apps/judge/src/generated/ruleset.ts\`
- \`apps/web/src/generated/judge_ruleset.schema.json\`

## Key semantics

### C-2: Exclusion markers affect coverage by **removing time** (not QC)
Marker kinds in \`marker.exclusion_kinds\` are treated as **excluded minutes** for coverage and gap calculations.

### C-3: missing-origin raw is **no evidence**
Raw samples with quality in \`evidence.raw_sample.missing_origin_quality_values\` are excluded from:
\`${ruleset.evidence.raw_sample.missing_origin_exclude_from.join(", ")}\`

They are not "bad evidence" â€” they mean "no evidence".
`;
writeFile(mdOut, md);

// 3) Frontend schema copy-through (so Admin UI can render a form)
const schema = readJson(schemaPath);
const schemaOut = path.join(repoRoot, "apps/web/src/generated/judge_ruleset.schema.json");
writeFile(schemaOut, JSON.stringify(schema, null, 2) + "\n");

console.log("[gen_ruleset] wrote:");
console.log(" -", tsOut);
console.log(" -", mdOut);
console.log(" -", schemaOut);
