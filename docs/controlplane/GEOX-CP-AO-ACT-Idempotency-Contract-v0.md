# GEOX · Sprint 20
# Apple III · AO-ACT Receipt Idempotency Contract v0

Status: DRAFT (freeze candidate)
Applies to: Control Plane · Apple III (AO-ACT)

## Purpose

AO-ACT receipt writes must be safe to retry.
A client (executor / gateway) must be able to resend the same receipt request after network failures without creating duplicate append-only facts that change system meaning.

This Sprint introduces a minimal idempotency discipline without introducing a scheduler, a queue, or any automatic retry engine.

## Contract (v0)

1) The endpoint `POST /api/control/ao_act/receipt` requires a non-empty, executor-generated idempotency key:

- `payload.meta.idempotency_key: string` (required, non-empty after trim)

2) The server defines a dedupe scope (5-tuple):

- `act_task_id`
- `executor_id.kind`
- `executor_id.id`
- `executor_id.namespace`
- `meta.idempotency_key`

3) If a receipt fact already exists with the same dedupe scope, the server MUST reject the request:

- HTTP 409
- `{ ok: false, error: "DUPLICATE_RECEIPT", existing_fact_id: "..." }`

4) If `meta.idempotency_key` is missing/empty, the server MUST reject the request:

- HTTP 400
- `{ ok: false, error: "IDEMPOTENCY_KEY_REQUIRED" }`

5) This Sprint does NOT modify the AO-ACT Task/Receipt JSON contract other than requiring the key to exist inside `meta`.

## Non-Goals / Negative Guarantees

- No scheduler / queue
- No server-side automatic retry
- No change to AuthZ semantics
- No change to existing AO-ACT task/receipt contract fields (beyond requiring `meta.idempotency_key`)
- No attempt to infer control signals from execution

## Notes

- The idempotency key is generated by the executor (or gateway) and MUST be stable across retries for the same logical receipt.
- The server performs a deterministic read-before-write check against the append-only facts ledger.
